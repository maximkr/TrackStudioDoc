<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" href="../helpproject.xsl" ?>
<topic template="Default" lasteditedby="Administrator" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../helpproject.xsd">
  <title translate="true">How to import tasks from e-mails sent by unregistered users</title>
  <body>
    <header>
      <para styleclass="Heading1"><text styleclass="Heading1" translate="true">How to import tasks from e-mails sent by unregistered users</text></para>
    </header>
    <para styleclass="Normal" style="text-indent:48px; background-color:#ffffff;"><text styleclass="Normal" style="font-family:Verdana; font-size:12pt; vertical-align:baseline; color:#000000;" translate="true">Some of our clients needed to import tasks from mail, including the ones sent by unregistered users. This feature was there in TrackStudio 3.5, but it had lots of problems associated with it, and now all these issues have been resolved. In TrackStudio 4.0, this can be done with the help of a single trigger.</text></para>
    <para styleclass="Code"><text styleclass="Code" translate="true">Attention! This script works very well in TrackStudio right from version 4.0.6.</text></para>
    <para styleclass="Normal" style="text-indent:48px; background-color:#ffffff;"><text styleclass="Normal" style="font-family:Verdana; font-size:12pt; vertical-align:baseline; color:#000000;" translate="true">We will create the tasks from email messages by using inbuilt import feature, while at the same time we will check for the presence of this user in the system, and, if required, we will create the new user, assign him the rights to the project and create the task in his name.</text></para>
    <para styleclass="Code Example"><text styleclass="Code Example" translate="true">package scripts.before_create_task;</text><br/><text styleclass="Code Example" translate="true">import com.trackstudio.app.adapter.AdapterManager;</text><br/><text styleclass="Code Example" translate="true">import com.trackstudio.exception.GranException;</text><br/><text styleclass="Code Example" translate="true">import com.trackstudio.external.TaskTrigger;</text><br/><text styleclass="Code Example" translate="true">import com.trackstudio.kernel.manager.KernelManager;</text><br/><text styleclass="Code Example" translate="true">import com.trackstudio.kernel.manager.UserManager;</text><br/><text styleclass="Code Example" translate="true">import com.trackstudio.secured.SecuredTaskTriggerBean;</text><br/><text styleclass="Code Example" translate="true">import com.trackstudio.tools.Null;</text><br/><text styleclass="Code Example" translate="true">import java.util.regex.Matcher;</text><br/><text styleclass="Code Example" translate="true">import java.util.regex.Pattern;</text><br/><text styleclass="Code Example" translate="true">public class CreateUserFromEmail implements TaskTrigger {</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160;public SecuredTaskTriggerBean execute(SecuredTaskTriggerBean task) throws GranException {</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160;String s = task.getDescription();</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160;String userStatusId = task.getSubmitter().getPrstatusId();</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160;if (s != null &amp;&amp; s.length() &gt; 0) {</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160;String emailPattern = &quot;From:\\s*\\\&quot;*(\\S+\\s*\\S+\\\&quot;*){0,1}\\s+&lt;*(\\S+@\\S+)&gt;*&quot;;</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160;// From: </text><link displaytype="text" defaultstyle="true" type="weblink" href="mailto:max.vasenkov@gmail.com" styleclass="Code Example" translate="true">max.vasenkov@gmail.com</link><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160;// From: Maxim Vasenkov &lt;max.vasenkov@gmail.com&gt;</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160;// From: Winzard &lt;i@winzard.ru&gt;</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160;// From: Admin &lt;admin@localhost&gt;</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160;// From: &quot; Maxim Vasenkov &quot; &lt;vasenkov@any.place.com&gt;</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160;Pattern pat = Pattern.compile(emailPattern);</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160;Matcher mat = pat.matcher(s);</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160;if (mat.find()) {</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;String userName = mat.group(1);</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;String userEmail = mat.group(2);</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;if (userName == null) userName = userEmail;</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;String fId = KernelManager.getUser().findUserIdByEmailNameProject(userEmail, userName, task.getParentId());</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;if (fId==null){</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;String id = AdapterManager.getInstance().getSecuredUserAdapterManager().createUser(task.getSecure(),</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;Null.beNull(task.getSubmitterId()), userEmail, userName, Null.beNull(userStatusId));</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;String aclid = AdapterManager.getInstance().getSecuredAclAdapterManager().createAcl(task.getSecure(),</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;task.getParentId(), null, id, null);</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;AdapterManager.getInstance().getSecuredAclAdapterManager().updateTaskAcl(task.getSecure(),</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;aclid, userStatusId, false);</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;if (id != null) task.setSubmitterId(id);</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;}</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; &#160; &#160;}</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160; }</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160; &#160; &#160;return task;</text><br/><text styleclass="Code Example" translate="true"> &#160; &#160;}</text><br/><text styleclass="Code Example" translate="true">}</text></para>
    <para styleclass="Normal" style="text-indent:48px; background-color:#ffffff;"><text styleclass="Normal" style="font-family:Verdana; font-size:12pt; vertical-align:baseline; color:#000000;" translate="true">Here the user is created with the same role, as the user executes indicated in the import rules, through which import is executed. User is given the rights to the higher task w.r.t the one being imported.</text></para>
    <para styleclass="Normal" style="text-indent:48px; background-color:#ffffff;"><text styleclass="Normal" style="font-family:Verdana; font-size:12pt; vertical-align:baseline; color:#000000;" translate="true">This</text><text styleclass="apple-converted-space" style="font-family:Verdana; font-size:12pt; font-weight:normal; font-style:normal; text-decoration:none; text-transform:none; vertical-align:baseline; color:#000000; background-color:transparent; letter-spacing:normal; letter-scaling:100%;" translate="true">&#32;</text><text styleclass="Normal" style="font-family:Verdana; font-size:12pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">Create Task/Before Trigger</text><text styleclass="apple-converted-space" style="font-family:Verdana; font-size:12pt; font-weight:normal; font-style:normal; text-decoration:none; text-transform:none; vertical-align:baseline; color:#000000; background-color:transparent; letter-spacing:normal; letter-scaling:100%;" translate="true">&#32;</text><text styleclass="Normal" style="font-family:Verdana; font-size:12pt; vertical-align:baseline; color:#000000;" translate="true">must be connected in the settings to the</text><text styleclass="apple-converted-space" style="font-family:Verdana; font-size:12pt; font-weight:normal; font-style:normal; text-decoration:none; text-transform:none; vertical-align:baseline; color:#000000; background-color:transparent; letter-spacing:normal; letter-scaling:100%;" translate="true">&#32;</text><text styleclass="Normal" style="font-family:Verdana; font-size:12pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">categories</text><text styleclass="apple-converted-space" style="font-family:Verdana; font-size:12pt; font-weight:bold; font-style:normal; text-decoration:none; text-transform:none; vertical-align:baseline; color:#000000; background-color:transparent; letter-spacing:normal; letter-scaling:100%;" translate="true">&#32;</text><text styleclass="Normal" style="font-family:Verdana; font-size:12pt; vertical-align:baseline; color:#000000;" translate="true">of those tasks, which are planned to be imported.</text></para>
    <para styleclass="Normal" style="text-indent:48px; background-color:#ffffff; page-break-before:always;"></para>
  </body>
</topic>
